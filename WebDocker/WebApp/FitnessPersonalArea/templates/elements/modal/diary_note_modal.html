{% block diary_note %}
{% load static %}
{% load i18n %}

<script type="text/python">
    from browser import document as doc, alert, ajax

    csrf_token = doc.get(name='csrfmiddlewaretoken')[0].value
    print(csrf_token)

    def on_complete(req):
        if req.status==200 or req.status==0:
            doc["result"].html = req.text
        else:
            doc["result"].html = "error "+req.text


    def post_request(url="{% url 'user_diary' %}", method="POST"):
        req = ajax.ajax()
        req.bind('complete',on_complete)
        # send a POST request to the url
        req.open(method,url,True)
        # set headers
        req.set_header('content-type','application/x-www-form-urlencoded')
        req.set_header('accept','text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8')
        req.set_header('X-Requested-With', 'XMLHttpRequest')

        # get form data
        diary_note_title = doc['diary_note_title_id'].text
        diary_note_text = doc['diary_note_text_id'].text
        diary_note_tags = doc['diary_note_tags_id'].text

        # send data as a dictionary
        req.send({'csrfmiddlewaretoken':csrf_token, 'diary_note_title': diary_note_title, 'diary_note_text': diary_note_text, 'diary_note_tags': diary_note_tags })

    doc["new_diary_note_btn"].bind("click", post_request)

</script>
    <!-- The Modal -->
    <div class="modal fade bd-example-modal-lg" id="newDiaryNote">
        <div class="modal-dialog  modal-lg">
            <div class="modal-content">

                <!-- Modal Header -->
                <div class="modal-header">
                    <h4 class="modal-title">
                        <i class="fas fa-book-open"></i>
                        {% trans "Ваш дневник" %}</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>

                <form name="new_diary_note" method="post" action="" id="new_diary_note" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- Modal body -->
                    <div class="modal-body">
                        <dl class="row">
                            <dt class="col-sm-4" style="padding-bottom: 20px">{% trans "Название записи"%}</dt>
                            <dd class="col-sm-8"><input type="text" id="diary_note_title_id" required name="diary_note_title" maxlength="100"></dd>

                            <dt class="col-sm-4" style="padding-bottom: 20px">{% trans "Текст записи"%}</dt>
                            <dd class="col-sm-8"><textarea class="form-control" id="diary_note_text_id"  type="text" name="diary_note_text"  maxlength="4000" required></textarea></dd>

                            <dt class="col-sm-4" style="padding-bottom: 20px">{% trans "Теги записи, через запятую"%}</dt>
                            <dd class="col-sm-8"><input type="text" id="diary_note_tags_id" required name="diary_note_tags" maxlength="50"></dd>
                        </dl>
                    </div>

                    <!-- Modal footer -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="new_diary_note_btn" name="new_diary_note_btn">{% trans "Сохранить" %}</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal">{% trans "Закрыть" %}</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <script>
    $("#new_diary_note").submit(function(e) {
        $.ajax({
            type: "POST",
            url: "{% url 'user_diary' %}",
            data: $("#new_diary_note").serialize(), // serializes the form's elements.
            success: function(data)
            {
                if (data.answer === true)
                    window.location.reload(true);
                else {
                    alert(data.error_answer)
                }
            }
        });

        e.preventDefault(); // avoid to execute the actual submit of the form.
    });
    </script>





{% endblock %}